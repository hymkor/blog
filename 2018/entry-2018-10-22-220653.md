Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2018/10/22/220653
Rem: App-Edited: 2018-10-22T22:06:53+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/10257846132658043675
Rem: Published: 2018-10-22T22:06:53+09:00
Category: nyagos
Updated: 2018-10-22T22:06:53+09:00
Title: nyagos の type, more で UTF16 をサポート
---
([qrunch.io](https://zetamatta.qrunch.io/entries/YgP2BBq3t6NGs8uy) より転記)

これな

* [type and more supports UTF16 (if it contains '\000' ...)  Issue #267  zetamatta/nyagos](https://github.com/zetamatta/nyagos/issues/267)

当初は「とりあえず書いてみた」という感じの issue で、そのうちニーズがない割に面倒なので、やめようかな…と思っていました。

が、最近、会社で過去に書いたプロダクトに問題があって、その修正をしていのたですが、ワークファイルが UTF16 で保存されていて、vim ではかろうじて開けるものの、more も grep も使えないので、たいへんなことに。

ということでですね、実は別途 ANSI/UTF8 の自動判別読み込みフィルター `"github.com/zetamatta/go-texts/mbcs".NewAutoDetectReader`を[別パッケージ](https://github.com/zetamatta/go-texts)で作ってまして、それを改善する形で取り込んで、UTF16 もサポートするようにしました。
**（※バイナリ版はまだリリースしていません）**

これの文字コード判別ルールは極めて簡単で

* \xFF\xFE で始まっていたら、UTF16LE 確定
* \xFE\xFF で始まっていたら、UTF16BE 確定
* 0スタートの偶数バイト目に \0 が存在していたら、UTF16BE 確定
* 奇数バイト名に \0 が存在していたら、UTF16LE 確定
* 任意の場所に \xEF\xBB\xBF があれば UTF8 確定
* １行単位で読み込んで、Go 言語の `"utf8".Valid()` が false ならば、非UTF8 のマルチバイト文字列と確定
* 以上でなければ、暫定的に UTF8 とする

実のところ、こんな判別ルールよりももっとたいへんなのが、	`"golang.org/x/text/transform"` のルールに準拠したテキストフィルターの書き方だったのですが、それはまた別の機会にでも