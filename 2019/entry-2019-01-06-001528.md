```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2019/01/06/001528
Rem: App-Edited: 2019-01-06T00:19:17+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/10257846132698357022
Rem: Published: 2019-01-06T00:15:28+09:00
Category:
Updated: 2019-01-06T00:15:28+09:00
Title: 今日の学び：CMD.EXE での遅延評価
```
nyagos では、バッチファイルを呼び出す時、環境変数の変更を取り込むため

```
%COMSPEC% /V:ON /S /C "call "バッチファイル名" &
set "ERRORLEVEL_=!ERRORLEVEL!" &
(cd & set > 一時ファイル名)  "
```

ということをしていた。

が、これ、ERRORLEVEL の値を参照するために遅延評価オプションを有効にしなくてはいけないため、バッチ実行時の CMD.EXE のデフォルト状態が変わってしまうという問題があった。

が、今日、この解決法が分かった。

[https://twitter.com/nullpo_head/status/1081502211752964099?s=20:embed]

リンク先の [nullpo-head/source-win-bat](https://github.com/nullpo-head/source-win-bat) のコードを見ると、

```
" & call set SW_EXITSTATUS=%^ERRORLEVEL% "
```

とかやってる。**`call set` !?** なんじゃそりゃ

ぐぐってみると、解説記事があった。

* [バッチファイル界の魔境『遅延環境変数』に挑む（おまけもあるよ） - Qiita](https://qiita.com/sawa_tsuka/items/c7c477cacf8c97792e17#%E6%96%B9%E6%B3%95%EF%BC%91call-set2%E5%9B%9E%E8%A7%A3%E9%87%88%E3%81%95%E3%81%9B%E3%82%8B)

なるほどね！さっそく nyagos にも組み込みました！

* [Call a batchfile without /V:ON to read ERRORLEVEL · zetamatta/nyagos@5ded755](https://github.com/zetamatta/nyagos/commit/5ded755ac0371e9046b921f37ce6e5e90119b33e)
