Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2019/01/26/110832
Rem: App-Edited: 2019-01-26T11:08:32+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/98012380839620133
Rem: Published: 2019-01-26T11:08:32+09:00
Category: nyagos
Updated: 2019-01-26T11:08:32+09:00
Title: NYAGOS保守ノート：OpenSSH でパスワード入力中に Ctrl-C で中断すると画面が乱れる
---
これな

* [Stopping OpenSSH with Ctrl-C on password prompt, Escape sequences and etc. are disabled. · Issue #353 · zetamatta/nyagos](https://github.com/zetamatta/nyagos/issues/353)

症状
===

nyagos から OpenSSH を起動して、パスワードプロンプトで Ctrl-C を押下すると、nyagos に復帰してこなくなる（ように見える）。

[f:id:zetamatta:20190126103235p:plain]

原因
===

これは実は nyagos には復帰しているのだが、コンソールのモードがパスワード表示向けの状態から元に戻っていないだけである。なので、画面が更新されないが「exit」と入力すると普通に終了する。

対応
===

コマンドを実行した後、コンソールの出力のモードをいちいち元に戻すようにした。入力のモードについては既に対応していたので、同じような対応を出力にもするようにした。

詳しくは差分みて

* [(#353) Restore console mode for stdout after executing command · zetamatta/nyagos@fc8674e](https://github.com/zetamatta/nyagos/commit/fc8674ef6df49b7509bfd6714e684e375b9a0660#diff-c985d860b8ecd7e6a8be7eec59a36d4f)

余談１
====

このコンソールのモードを変える関数([dos.ChangeConsoleMode](https://github.com/zetamatta/nyagos/blob/master/dos/windows10.go))の仕様は我ながらなかなかうまいこと作れていると思う

```golang
if restore,err := dos.ChangeConsoleMode(windows.Stdout, dos.ModeSet(enableVirtualTerminalProcessing)) ; err == nil {
    defer restore()
}
```

* モードを元に戻す関数（クロージャ）を戻り値に変えす。一時的にモードを変えるだけなら、これを defer で戻すようにすればよい
* モードのセット・リセットは、`dos.ModeOp` というインターフェイスを実装した `dos.ModeSet` , `dos.ModeReset` という型をパラメータとして０個以上渡せばよい。
* コンソールのハンドルはいちいち自分で `"$CONIN"` `"$CONOUT"` をオープンしなければいけないと思いがちだが、実は準標準の `golang.org/x/sys/windows` に windows.Stdout とか windows.Stdin がそのままあるので、これを使った方が早い。

余談２
====

なぜ、Ctrl-C で OpenSSH を中断すると、コンソールのモードを元に戻してくれないのか？ [beepcap さん](https://twitter.com/beepcap/status/1088568959123697664?s=20)によると、CMD.EXE や PowerShell 上では同症状は発生しなかったそうだ。

可能性としては以下の２説がある。

* CMD.EXE や PowerShell はコマンド実行ごとにいちいちコンソールモードをリセットしている
* Ctrl-C をキャッチした時の子プロセスの殺し方がまずい（SIGKILL相当）ので、OpenSSH が SIGINT 扱いでハンドルできない

nyagos の Ctrl-C の扱いについては、最近(go-tty導入前後)になってからうまく処理できなくなったので、 `"os/exec".Run` を参考にして最近実装しなおしたのだが…見直しが必要かもしれない。

Ctrl-C の取扱については、現在のように Go言語の "os/signal" の関数を使うほか、Windows のそれ用の API [SetConsoleCtrlHandler](https://docs.microsoft.com/en-us/windows/console/setconsolectrlhandler)がある。
おいおいと調べなくては…

