```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2019/03/16/160557
Rem: App-Edited: 2019-03-20T23:42:27+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/17680117126994418612
Rem: Published: 2019-03-16T16:05:57+09:00
Category: nyagos
Updated: 2019-03-16T16:05:57+09:00
Title: Windows のコンソールと、Unicode のサロゲートペアとゼロ幅文字
```
（2019.03.20 追記：Windows7 の Chrome では Unicode の合字が表示されないので、合字を画像に変えました）

[f:id:zetamatta:20190320233847p:plain:alt=👨‍👩] という文字を nyagos に貼り付けると、文字化けするだけでなく、カーソル位置もおかしくなるという問題

* [Zero width char deletion problem? · Issue #360 · zetamatta/nyagos](https://github.com/zetamatta/nyagos/issues/360)

これは２つ問題がある

* [f:id:zetamatta:20190320233847p:plain:alt=👨‍👩] という文字が合字である
    * １コードポイントではなくて、「👨(U+1F468)」＋[ゼロ幅接合子(U+200D)](https://ja.wikipedia.org/wiki/%E3%82%BC%E3%83%AD%E5%B9%85%E6%8E%A5%E5%90%88%E5%AD%90)＋ 「👩(U+1F469)」という３コードポイントからなっている
    * nyagos は合字を想定していない
    * ゼロ幅接合子の単体の桁数は0桁である点は、go-runewidth で把握できている
* 👨と👩各文字ともサロゲートペアで表現される
    * Windows のコマンドプロンプトはサロゲートペアな Unicode の出力をサポートしていない
       * そもそもコンソールバッファのひとマスが16bitしか確保されていないんだよな
    * 実際に出力すると１文字なのに２文字と認識されたり、カーソル位置がおかしくなってしまう。
    * フォントが足りる・足りないの問題ではない

ということで「サロゲートペアな文字」も「ゼロ幅文字」もきちんと表示するのは無理とわかったので、nyagos の一行入力では `<UUUUU>` みたいな形で表現するようにした。`^I` とかと同じ扱いで、表示上は５桁になっているがバックスペース１回で削除できるし、コマンドに出力する時は元の文字に直して出力される
（一応、この動作は `--output-surrogate-pair` というオプションで抑制する（＝そのまま表示するようにする）ことが出来るようにはしておいた）

将来的にこういった文字もコマンドプロンプトで表示できるといいんですが。絵文字が使えないというのはさびしいので…（というか、将来、実用上も困るシーンが出てきそう）

本件、ご協力いただいた tsuyoshicho さん、ありがとうございました。
