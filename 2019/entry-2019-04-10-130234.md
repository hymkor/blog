```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2019/04/10/130234
Rem: App-Edited: 2019-04-10T13:02:34+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/17680117127018226217
Rem: Published: 2019-04-10T13:02:34+09:00
Category: VC++
Updated: 2019-04-10T13:02:34+09:00
Title: VC++で書いたアドオンDLLの中で独自ダイアログが表示できなかった件
```
とあるアプリのアドオンを VC++ で書いていたんだけれども、自作のダイアログを出そうとしてもなぜか DoModal が素通りしてしまう。

しかも、Visual Studio 自体もなぜか不安定で、クラスウィザードのクラッシュも多発して、原因の切り分けができない！！！

１日半ほど苦闘した結果、ようやく以下の情報に巡り合った

* [VCのDLL内で画面を表示させるには？](https://www.papy.in/bbs/vc/200210/02100016.html)
* [拡張DLLでのリソース](http://dss.o.oo7.jp/cgi/PT.cgi?VCPP/DLL/dllresource2)

どうやら、EXE側からDllMainの第一引数で与えられているハンドルを DLL側で適切に設定しなくては、DLL側でリソースを使えないらしい
（クラッシュの原因は別件なので、ここでは省く）

昨今、ウェブの情報も永遠ではないので、ミラーというかバックアップとして、こちらのソースも晒しておこう。

```cpp

// DLL のモジュールハンドル
extern "C" HINSTANCE _hdllInstance = NULL;
HINSTANCE GetInstance()
{
	return _hdllInstance;
}

BOOL APIENTRY DllMain(
	HINSTANCE hInstance, 
	DWORD dwReason, 
	LPVOID pReserved)
{
    _hdllInstance = hInstance;
    ; // 中略
}

void example()
{
    const HINSTANCE hInstance = AfxGetResourceHandle();
    AfxSetResourceHandle(GetInstance());

    CSelectDwg dlg1;
    dlg1.DoModal();

    AfxSetResourceHandle(hInstance);
}
```
