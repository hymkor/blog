Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2019/10/27/233140
Rem: App-Edited: 2023-04-28T22:52:18+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/26006613456518076
Rem: Published: 2019-10-27T23:31:40+09:00
Category: go
Updated: 2019-10-27T23:31:40+09:00
Title:  Go言語の実行ファイルのパッケージを作成するバッチファイル
---
GOOS=windows or linux、GOARCH=amd64 or 386 という組み合わせで、`(フォルダー名)-(年月日)-(GOOS)-(GOARCH).zip` という zip ファイルを作ります。


**go-package.cmd**

```
@echo off
setlocal
set "PROMPT=$ "
for %%I in (%CD%) do set "NAME=%%~nI"
for %%I in (windows linux) do for %%J in (amd64 386) do call :one %%I %%J
endlocal
exit /b

:one
    set GOOS=%1
    set GOARCH=%2
    set SUFFIX=
    if %GOOS% == windows set "SUFFIX=.exe"
    echo GOOS=%GOOS% GOARCH=%GOARCH%
    @echo on
    go build
    zip -9 %NAME%-%DATE:/=%-%GOOS%-%GOARCH%.zip %NAME%%SUFFIX%
    @echo off
    exit /b
```

これで作ったリリースがこちら

* [Release 20191027 · zetamatta/csview](https://github.com/zetamatta/csview/releases/tag/20191027)

#### 追記 (2019.11.02)

ちょっと直しました。

```
@echo off
setlocal
set "PROMPT=$ "
for %%I in (%CD%) do set "NAME=%%~nI"
for %%I in (windows linux) do for %%J in (386 amd64) do call :one %%I %%J
endlocal
exit /b

:one
    set GOOS=%1
    set GOARCH=%2
    set SUFFIX=
    if %GOOS% == windows set "SUFFIX=.exe"
    echo GOOS=%GOOS% GOARCH=%GOARCH%
    @echo on
    go build -ldflags "-s -w"
    zip -9 %NAME%-%DATE:/=%-%GOOS%-%GOARCH%.zip %NAME%%SUFFIX%
    @echo off
    exit /b
```

* ビルドする順番が amd64 → 386 だったのを 386 → amd64 にした
    * あとに残った実行バイナリが 386 だと、WSL で Linux 版を即テストできないから
* go のオプションに `-ldflags "-s -w"` を追加して実行ファイルのサイズを小さくした

以上です