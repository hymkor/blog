Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2020/07/25/171204
Rem: App-Edited: 2020-07-25T17:47:48+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/26006613604187115
Rem: Published: 2020-07-25T17:12:04+09:00
Category:
Updated: 2020-07-25T17:12:04+09:00
Title: Lua 5.4 のバイナリが出てた！
---
いきなり丸投げの関連リンク

* [Lua 5.4 readme](https://www.lua.org/manual/5.4/readme.html#changes)
* [Lua Binaries](http://luabinaries.sourceforge.net/)
* [Lua5.4 の主な変更点 - 公開技術情報](https://ifritjp.github.io/documents/lua/lua5.4/)

Lua 5.4 の目玉は to-be-closed variable だと思うんだけど、lua.org の[説明](https://www.lua.org/manual/5.4/manual.html#3.3.8) 見ても、書き方がさっぱり分からない
（そもそもサンプルコードもないぞ）。

上記の日本語の解説ページを見てやっと分かった。こんな感じでいいらしい

```lua
function new()
    return setmetatable({},{
        __close = function(this) print("__closed called") end ,
        __gc = function(this) print("__gc called") end }
    )
end
do
    local x<close> = new()
    print("Block ends")
end
print("Program terminated")
```

```
$ lua54 foo.lua
Block ends
__closed called
Program terminated
__gc called
```

`<close>` という修飾子を変数の後につけると、その「変数」の有効範囲を抜けた時に、メタテーブルの `__close` に登録されたメソッドが呼び出されるらしい。
これはリソースの後片付けに便利！
（Lua から COM オブジェクトを呼ぶ時、後片付けに Release というメソッドをいちいち呼ばなくてはいけなかったんよ）

だけど、なんでパーサーが大変な `<close>` なんて表現にしたかなぁ。`local x<close>=` ではなく、 `using x =` みたいな方が楽だと思うんだけど。謎だ

----

Dependency Walker で依存ファイルを確認した。

lua54.dll は MSVCRT.dll にしか依存していない。

[f:id:zetamatta:20200725173927p:plain]

lua54.exe も lua54.dll と MSVCRT.dll にしか依存していない。

[f:id:zetamatta:20200725174022p:plain]

普通に MinGW/gcc でビルドすると、DLL が MinGW のランタイムを必要としてしまうが、そうなっていないところを見るとまた古めの MinGW でビルドしてるのかな？