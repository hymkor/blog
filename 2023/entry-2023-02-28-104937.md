Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2023/02/28/104937
Rem: App-Edited: 2024-01-21T12:59:21+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/4207112889967187879
Rem: Published: 2023-02-28T10:49:37+09:00
Category: C++
Updated: 2023-02-28T10:49:37+09:00
Title: 古い VC++ でコンパイルエラーになったが、gcc 11.2.0 だと普通に動いてしまった unique\_ptr を使ったコード
---
map から map へ要素を移動するのに、unique\_ptr を使いたかったが、当時使っていた VC++ 2010 か 2015[^VC] では、コンパイルエラーになってしまった。
[^VC]: どっちだったか、ちょっと覚えていない
その時は結局、shared\_ptr を使って回避した。

今、gcc 11.2.0 で試してみると問題は再現しない。コンパイラの不具合でよかったのだろうか
（もう手元には VC++ がないので、検証できない）

```cpp
#include <iostream>
#include <map>
#include <memory>
#include <string>

struct Hoge {
    std::string value;

    Hoge();
    ~Hoge();
};

Hoge::Hoge(){
    std::cout << "ctor called." << std::endl;
}

Hoge::~Hoge(){
    std::cout << "dtor called." << std::endl;
}

int main(){
    std::map<int,std::unique_ptr<Hoge>> src;
    std::map<int,std::unique_ptr<Hoge>> dst;

    std::unique_ptr<Hoge> p(new Hoge);
    p->value = "ahaha";

    src[1] = std::move(p);
    dst[2] = std::move(src[1]);
    src.erase(1);

    for(auto p=dst.begin() ; p != dst.end() ; p++){
        std::cout << "dst[" << p->first << "]= " << p->second->value << std::endl;
    }
    return 0;
}
```

```
$ g++ unique.cpp
$ a
ctor called.
dst[2]= ahaha
dtor called.
```
