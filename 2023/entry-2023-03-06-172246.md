```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2023/03/06/172246
Rem: App-Edited: 2024-03-23T12:13:19+09:00
Rem: Draft: yes
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/4207112889969054898
Rem: Published: 2023-03-06T17:22:46+09:00
Category: minecraft BatchFile
Updated: 2023-03-06T17:22:46+09:00
Title: Java版マインクラフトのデータを rclone で「さくらぽけっと」へバックアップする
```
前にこんなテキストかいた。

- [Java版マインクラフトのデータを OneDrive へバックアップしよう - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2020/09/11/214526)

OneDrive も手狭になってきたので、容量があまっている[さくらぽけっと] の方を使うことにした。

[さくらぽけっと]の特徴：

- レンタルサーバで使っているディスクの一部に、ウェブブラウザや FTP などで任意のファイルを置けるサービス
    - 他のクラウドストレージのような PC のローカルディスクとの同期機能などはない
    - スマホアプリでファイル置けるみたいだけど、そちらは知らね
- ライトプランの場合は FTP とウェブブラウザでしかアクセスできない  
  （スタンダードプランであれば ssh が使えるが、コスト節約でライトにしてしまった）
- ファイル名の文字コードは、なんと EUC-JP（いまどき！という感じだが、昔からあるサービスだからなぁ）

文字コードのトラブルは避けたいところなので、置くのは ASCII文字だけの名前のファイルだけにしておいたほうがよさそうだ。

ファイルの転送方法は、OneDrive であれば黙っていても勝手に転送してくれたが、今回は FTP を使う。ひと昔前なら Windows の FTP.EXE とか、ncftpput を使っていたところだが、現代には [rclone]という万能ファイル転送テクノロジーがあるのだ。

まずは `rclone config` で、[さくらぽけっと] への接続情報を登録する。

```
$ rclone config
Current remotes:

Name                 Type
====                 ====

e) Edit existing remote
n) New remote
d) Delete remote
r) Rename remote
c) Copy remote
s) Set configuration password
q) Quit config
e/n/d/r/c/s/q> n

Enter name for new remote.
name> sakura
```

[rclone] で使う接続先名は `sakura` とする。そのあと、インタラクティブに接続情報を入力してゆくが、そこは秘密情報も含まれるので省略する。

以下はバックアップを行うバッチファイル minecraft.cmd :

``` minecraft.cmd
setlocal
pushd "%APPDATA%"
if "%~1" == "/v" (
    rclone cat "sakura:sakura_pocket/Backup/Game/dotminecraft-%DATE:/=%.tar.zst" | zstd -d | tar tvf -
) else (
    move ".minecraft\screenshots\*.png" "%USERPROFILE%\OneDrive\画像\dotminecraft\."
    tar --exclude ".minecraft/backups/*.zip" -cvf - .minecraft | zstd | rclone rcat "sakura:sakura_pocket/Backup/Game/dotminecraft-%DATE:/=%.tar.zst"
)
popd
endlocal
```

`minecraft` だけでバックアップ、`minecraft /v` でテストを行う。接続情報・認証情報をスクリプトの中に書かなくてもよいところがありがたい。

`rclone copy` , `rclone move` でもよいのだが、それだとローカルに巨大な tar ファイルを一度作らなくてはいけない。`rclone rcat` を使うと、標準入力から受け取ったデータをリモートでファイル化できるので、ローカルに一時ファイルを作る必要がなくなる。テストの際は逆に `rclone cat` を使えば、リモートファイルの内容を標準出力に出してくれる。

これらは tar や zstd の標準入出力とそのままつなげられる。まったく便利な世の中になったものだなぁ。

[さくらぽけっと]: https://rs.sakura.ad.jp/sakurapocket
[rclone]: https://rclone.org/
