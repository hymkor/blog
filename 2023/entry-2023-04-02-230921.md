Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2023/04/02/230921
Rem: App-Edited: 2024-01-21T12:57:10+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/4207112889977355410
Rem: Published: 2023-04-02T23:09:21+09:00
Category: Go
Updated: 2023-04-02T23:09:21+09:00
Title: go-readline-ny：カラー化の手引き
---
**（2023/04/14：追記）**  
v0.10.0 にて非互換性を含む修正を行ったため、その変更点を反映しました。

---

[go-readline-ny]: https://github.com/nyaosorg/go-readline-ny
[SGR]: https://en.wikipedia.org/wiki/ANSI_escape_code#SGR_(Select_Graphic_Rendition)_parameters

[go-readline-ny] は v0.6.1 から文字ごとに色を変更できるようになりました。

この配色は固定ではなく、readline.Editor のフィールド Coloring に設定されたオブジェクトに問い合わせて決定するようになっています。同オブジェクトは、次のインターフェイスを満たしている必要があります。

```go
type Coloring interface {
    // Reset has to initialize receiver's fields and return default color.
    Init() ColorSequence // <-- v0.10.0 にて int より変更
    // Next has to return color for the given rune.
    Next(rune) ColorSequence // <-- v0.10.0 にて int より変更
}
```
※ v0.10.0 より、戻り値を int より readline.ColorSequence （実態は int64）に変更しました。

このインターフェイスは次のように使われます（コードはイメージです。本物はもっとゴチャゴチャしてます）

```go
func (editor *Editor) printLine(){
    X = editor.Coloring
    defaultColor := X.Init()
    last := ColorSequence(-1)
    for i, r := range テキスト全体 {
        c := X.Next(r) // 表示範囲外でも二重引用符の内外など判断をNextの中ですることがあるので一応呼ばれる
        if 表示開始位置 <= i && i < 表示終了位置 {
            if c != last {
                colorSet(c) ; last = c
            }
            printRune(r)
        }
    }
    if last != defaultColor {
        colorSet(defaultColor) // 表示が終わったあと、標準色に戻すため Init の戻り値が使われる
    }
}
```

Init や Next で返すべき色コード `c` はANSIエスケープシーケンスの [SGR]、いわゆる 「ESC[𝑛₁;𝑛₂;...m」の 数列 𝑛ₖ を一つの ~~32bit~~ <ins>64bit</ins> コードにパックしたコードになります。パックには SGR1～SGR4 という関数を用います。

- `ESC[39m` → `readline.SGR1(39)`
- `ESC[1;39m` → `readline.SGR2(1, 39)`
- `ESC[37;22;41m` → `readline.SGR3(37, 22, 41)` 

また、よく使うものについては readline の本体側でも `readline.Black` , `readline.Red` というような形で[定義](https://github.com/nyaosorg/go-readline-ny/blob/9bd01b73e06d35d12f9c6dd1fbec6438d1c1dee7/color.go#L14)しています。

これを実際に実装したものは

- [github.com/nyaosorg/go-readline-ny/coloring/vimbatch.go](https://github.com/nyaosorg/go-readline-ny/blob/1d97ade75bf5ec1181adfb52a0b58baed2d8d6ad/coloring/vimbatch.go)  
   → Coloring のサンプル実装VimBatch（vim上でのバッチファイルのシンタックスハイライト風）   
- [github.com/nyaosorg/nyagos/internal/frame/coloring.go](https://github.com/nyaosorg/nyagos/blob/e589106497d60150f9c65f9eb1612623e51b4965/internal/frame/coloring.go)  
（nyagos で実際に使われているもの）

になります。VimBatch では

* デフォルトは端末デフォルト文字色＋端末デフォルト背景色＋高輝度（`ESC[1;49;39m`）
* 全角空白`\u3000` は文字色「白」、背景色「赤」
* 環境変数 `%`～`%` の間はシアン
* 文字列 `"`～`"` の間はマゼンダ
* `&` は暗い黄色

という４種類のみを定義しています（以下、VimBatch の定義）

[f:id:zetamatta:20230402204950p:plain]

こうして実装した Coloring オブジェクトは、[github.com/nyaosorg/go-readline-ny/examples/example2.go](https://github.com/nyaosorg/go-readline-ny/blob/9bd01b73e06d35d12f9c6dd1fbec6438d1c1dee7/examples/example2.go#L26) のように設定しておけばOKです。
