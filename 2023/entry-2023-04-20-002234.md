```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2023/04/20/002234
Rem: App-Edited: 2024-09-13T22:13:30+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/4207112889982818806
Rem: Published: 2023-04-20T00:22:34+09:00
Category: Go SQL-Bless
Updated: 2023-04-20T00:22:34+09:00
Title: SQL-Bless 製作中に把握が必要になった各DBの違い（随時更新）
```
+ [hymkor/sqlbless: The Command-line Database Client](https://github.com/hymkor/sqlbless)

### 共通

+ 型名は DB ごとにばらばらだが、ANSI SQL の型がエイリアスになっている模様
    + 可変長文字列型 → CHARACTER VARYING(n)
    + 数値型 → NUMERIC[(n)]

### Oracle Database 21 Express Edition

+ コマンドラインクライアントによるデフォルトインスタンスへのログインは  
`sqlplus system/(インストーラーで設定したパスワード)@xe`
+ インスタンスの起動・停止はスタートメニューの Oracle Instance Manager より（OS Boot の際、自動的に起動される）
+ SQL\*Plus の中で、テーブルの仕様を確認するコマンドは `desc テーブル名`、テーブル一覧を保有する簡単なテーブル（もしかしたらビューかも）として `TAB` がある
    + 列の詳細はテーブル `all_tab_columns` で確認できる
+ Go言語のドライバーとして、今回は https://github.com/sijms/go-ora を使用
    + 接続文字列の仕様は `oracle://ユーザ名:パスワード@ホスト名:1521/xe`
+ 位置指定のプレースホルダーは `:1`, `:2`,…
+ 日時型は二種類
    + DATE - 日付+時刻
    + TIMESTAMP - 日付+時刻+[1秒未満の時刻](https://itsakura.com/orale-date-timestamp)

| DatabaseTypeName() | ScanType().String()
|--------------------|---------------------
| NCHAR              | string
| NUMBER             | float64

### PostgreSQL

+ `scoop install postgresql` だけでインストールできた。さすが OSS
+ コマンドラインクライアントによるデフォルトインスタンスへのログインは  
`psql "host=127.0.0.1 port=5432 user=postgres dbname=postgres sslmode=disable"`
+ インスタンスの起動・停止は `pg_ctl start` / `pg_ctl stop`  
  (OSブートで勝手に立ち上がらなかった。よし)
+ PostgreSQL ではトランザクション内でエラーが一度でも起きると、以後、ロールバックを行うまで、ずっとエラーになる[^osekkai]
+ psql の中で、テーブルの仕様を確認するコマンドは `\d テーブル名`、テーブル一覧は `\d` で確認できる
    + 詳細を確認は [pg\_attribute]（テーブルの列情報）、[pg\_class]（テーブルの名前などの情報）、[pg\_type]（データの型情報）などのテーブルを参照する。
+ Go言語のドライバーとして、今回は https://github.com/lib/pq を使用
    + 接続文字列の仕様は（例） `host=127.0.0.1 port=5432 user=postgres dbname=postgres sslmode=disable`
+ 位置指定のプレースホルダ―は `$1`, `$2`…
+ [日時型は3種類](https://www.postgresql.jp/document/9.2/html/datatype-datetime.html)[^tz]
    + timestamp - 日付時刻
    + date - 日付のみ時刻なし
    + time - 時刻のみ日付なし

[pg\_attribute]: https://www.postgresql.jp/document/9.3/html/catalog-pg-attribute.html
[pg\_class]: https://www.postgresql.jp/document/8.3/html/catalog-pg-class.html
[pg\_type]: https://www.postgresql.jp/document/9.3/html/catalog-pg-type.html

[^tz]: 厳密にはタイムゾーンの有無もあったりするが、SQL-Bless では、そこまで関与しないことにした

| DatabaseTypeName()  | ScanType().String()
|---------------------|--------------------
| NAME                | interface{}
| INT2                | int16
| INT4                | int32
| BOOL                | bool
| \_TEXT              | interface{}
| VARCHAR             | string
| NUMERIC             | interface {}
| DATE,TIME,TIMESTAMP | time.Time

### Microsoft SQL Server 

+ コマンドラインクライアントによるデフォルトインスタンスへのログインは  
`sqlcmd -S （自分のPC名） -E` （-S は接続先サーバー、-E は Windows認証を使うことを表す）
+ インスタンスの起動・停止はスタートメニューの SqlServer Configuration Manager より
+ sqlcmd の中で、テーブル一覧を見るコマンドは不明
    + [sys.objects]（テーブルやビューなど）、[sys.columns]（列情報）、[sys.types] （型情報）などのテーブルを参照する。
+ Go言語のドライバーとして、今回は https://github.com/microsoft/go-mssqldb を使用
    + 接続文字列の仕様はレポジトリに書いてあるが、**Windows 認証のことがどこにも書いていない**。[^winauth]  
        [参考記事]を見ながら試行錯誤した結果、`sqlserver://@localhost?database=master` でよかった  
     （ユーザ名、インスタンス名などは省かなくてはいけなかった）
+ PostgreSQL のようにエラーがあると、トランザクションが壊れるということはなかった。
+ 位置指定のプレースホルダ―は `@p1`, `@p2`, ...
+ 日時型は無駄に多い: time, date, smalldatetime, datetime, datetime2, datetimeoffset
    + [日付と時刻のデータ型および関数 - SQL Server (Transact-SQL) | Microsoft Learn](https://learn.microsoft.com/ja-jp/sql/t-sql/functions/date-and-time-data-types-and-functions-transact-sql?view=sql-server-ver16#DateandTimeDataTypes)
+ 日時の変換関数も独特(書式の指定が整数の定数とは)
    + [CAST および CONVERT (Transact-SQL) - SQL Server | Microsoft Learn](https://learn.microsoft.com/ja-jp/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-ver16)
    + 本来二行であらわすべきものを一行につめこんでいるので、表が読みづらい


| DatabaseTypeName() | ScanType().String()
|--------------------|--------------------
| NVARCHAR           | string
| INT                | int64
| DATETIME           | time.Time
| BIT                | bool
| CHAR               | string
| DECIMAL            | []uint8
| VARCHAR            | string

[sys.objects]: https://learn.microsoft.com/ja-jp/sql/relational-databases/system-catalog-views/sys-objects-transact-sql?view=sql-server-ver16
[sys.columns]: https://learn.microsoft.com/ja-jp/sql/relational-databases/system-catalog-views/sys-columns-transact-sql?view=sql-server-ver16
[sys.types]: https://learn.microsoft.com/ja-jp/sql/relational-databases/system-catalog-views/sys-types-transact-sql?view=sql-server-ver16
[参考記事]: https://user-first.ikyu.co.jp/entry/2017/12/07/180000

### MySQL

+ `scoop install mysql` だけでインストール可能
+ コマンドライン栗案とは `mysql`
    + データベースへの接続は `mysql` → `use データベース名`
    + データベースは `create database データベース名` だけで作れる
+ インスタンスの起動は `mysqld --standalone` 。停止は Ctrl-C で、いいのかな
+ Go言語のドライバーとして https://github.com/go-sql-driver/mysql を使用
+ テーブル一覧は `information_schema.tables`、カラム一覧は `information_schema.columns` で
+ 接続文字列は `username:password@protocol(address)/dbname?param=value` だが、デフォルトなら `root:@/dbname` でいける（`dbname` は `mysql`→ `show databases` で確認できる）
+ 日時型は、 `DATE`: 日付のみ, `DATETIME`: 日付+時刻, `TIMESTAMP`: エポック秒, `TIME`: 時刻, `YEAR2`: 2桁年(なぜ), `YEAR4`: 4桁年(なぜ)。時刻はマイクロ秒単位
+ 日時変換関数は独特
    + `STR_TO_DATE('日時文字列','フォーマット文字列')`
    + フォーマット文字列はC言語風: `%Y/%m/%d`
        + `%Y`: 4桁西暦, `%m`: 2桁月, `%d`: 2桁日, `%H`: 00時〜23時, `%i`: 分, `%s`: 秒
        + `%c`: 0埋めなし月, `%e`: 0埋めなし日, `%k`: 0埋めなし0時〜23時, 
    + [SQL│文字列を日付型に変換するTo_Date・Convert | アナリティクス沖縄│DataAnalytics](https://analytics-okinawa.jp/sql/2292/#index_id4)
    + [MySQL :: MySQL 8.0 Reference Manual :: 14.7 Date and Time Functions](https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_str-to-date)
+ プレースホルダは `:名前` 形式

| DatabaseTypeName() | ScanType().String()
|--------------------|--------------------
| DECIMAL            | sql.RawBytes
| VARCHAR            | sql.RawBytes

[^winauth]: SQL Server 認証にするのは簡単だが、後々、プログラムのサポートでWindows 認証でログインできないという問い合わせが来たときに調べなければいけないことを考えると、今調べておいた方がよいと考えた。
[^osekkai]: おせっかいの変態仕様め
