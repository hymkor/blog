```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2023/12/25/182525
Rem: App-Edited: 2024-01-21T11:59:49+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189069677695
Rem: Published: 2023-12-25T19:14:38+09:00
Category: PowerShell
Updated: 2023-12-25T18:25:25+09:00
Title: PowerShell 7.4 でのパイプラインならパラレルで動いた。
```
- [PowerShellのパイプラインは各外部コマンドをパラレルに実行しない - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2023/12/25/121910)

の続き。その後、 X(旧twitter)にて

- [Xユーザーのmethaneさん: 「@NyaosOrg https://t.co/9hp4OiUUmR この試験機能を有効にした場合も並列にはしてくれないんでしょうか？」 / X](https://twitter.com/methane/status/1739133298381893813)

という情報を頂戴したので、試してみた。

現在インストールされている PowerShell は

```
PS C:\Users\hymkor> Get-Host | Select-Object Version

Version
-------
5.1.22000.2538
```

つまり、5.1 だ。リンク先：[PowerShell の試験的機能の使用 - PowerShell | Microsoft Learn](https://learn.microsoft.com/ja-jp/powershell/scripting/learn/experimental-features?view=powershell-7.4#psnativecommandpreservebytepipe)によると

- `curl -s -L $uri | tar -xzvf - -C .` といった機能が期待どおり動く
- PowerShell 7.4 以降でメインストリームになっている

とのことらしい。ならば、最新版を入れてみよう

#### PowerShell 7 のインストール

- [Windows PowerShell 5.1 から PowerShell 7 への移行 - PowerShell | Microsoft Learn](https://learn.microsoft.com/ja-jp/powershell/scripting/whats-new/migrating-from-windows-powershell-51-to-powershell-7?view=powershell-7.4#installing-powershell-7)

```
$ winget search Microsoft.PowerShell
$ winget install --id Microsoft.Powershell --source winget
```

PowerShell の最新版の実行ファイル名は PowerShell.exe ではなく、pwsh.exe にかわったと、どこかで聞いた。

```
$ pwsh
PowerShell 7.4.0
PS C:\Users\hymkor>
```

特にバージョンを表示するコマンドを実行しなくても起動時に表示してくれるようになったらしい。ありがたい。

#### 検証

例のスクリプトは無変更で、呼び出し方法だけ

```
$ pwsh.exe ~\Share\cmds\backup-Demo_world.ps1
```

と変えてみた (`-ExecutionPolicy RemoteSigned -file` みたいなオプションを付けなくても起動できるのは嬉しい)

[f:id:zetamatta:20231225182606p:plain]

消費メモリがかなり少なくなった。すばらしい。

さて、この .tar.zst アーカイブ、壊れてないだろうか。
先日の verify-Demo\_World.cmd で検証してみよう。

```
$ rclone cat "(略)/minecraft-Demo_World-20231225.tar.zst"   | zstd -dc   | verifyarc -C "(略)\AppData\Roaming\.minecraft\saves" -
ARCHIVE: [OK] Demo_World/icon.png
ARCHIVE: [OK] Demo_World/level.dat
    : 中略
ARCHIVE: [OK] Demo_World/region/r.-2.11.mca
ARCHIVE: [OK] Demo_World/region/r.-2.12.mca
/*stdin*\ : Decoding error (36) : Data corruption detected
ARCHIVE: [DIFFER] Demo_World/region/r.-2.13.mca
2023/12/25 18:06:59 ERROR : minecraft-Demo_World-20231225.tar.zst: Failed to send to output: write /dev/stdout: The pipe has been ended.
2023/12/25 18:07:00 Failed to cat: write /dev/stdout: The pipe has been ended.
START=2023/12/25 月 18:01:20.16
END=2023/12/25 月 18:07:00.76
```

どうもネットワーク不調でうなくいかない…
( これは CMD.exe 版のバックアップに対しても発生した )

rclone は今はあきらめて、手動(ftp.exe) でリトライだ

```
ftp> bin
200 Type set to I
ftp> get minecraft-Demo_World-20231225.tar.zst
200 PORT command successful
150 Opening BINARY mode data connection for minecraft-Demo_World-20231225.tar.zst (3769602366 bytes)
226 Transfer complete
ftp: 3769602366 バイトが受信されました 1608.86秒 2343.03KB/秒。
ftp> bye
221 Goodbye.
```

```
$ zstd.exe -d < minecraft-Demo_World-20231225.tar.zst | verifyarc.exe -C "%APPDATA%\.minecraft\saves" -
ARCHIVE: [OK] Demo_World/icon.png
ARCHIVE: [OK] Demo_World/level.dat
ARCHIVE: [OK] Demo_World/level.dat_mcr
:
FILESYS: [OK] Demo_World\DIM-1\region\r.9.-12.mca
FILESYS: [OK] Demo_World\DIM-1\region\r.9.-13.mca
$
```

あらかじめ全部ダウンロードした状態なら、問題がないことを確認できた。よしよし
