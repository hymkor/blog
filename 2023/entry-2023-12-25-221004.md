Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2023/12/25/221004
Rem: App-Edited: 2024-01-21T11:59:26+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189069736220
Rem: Published: 2023-12-25T22:15:15+09:00
Category: PowerShell
Updated: 2023-12-25T22:10:04+09:00
Title: PowerShell 関係の環境整備
---
前回：[PowerShell 7.4 でのパイプラインならパラレルで動いた。 - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2023/12/25/182525) で、PowerShell 7.4 をインストールしたので、ついでに PowerShell 関係の環境を少し整えた。

#### キーバインドを Emacs 風に変更

[PowerShell で Linux の shell っぽいキーバインドを利用する](https://zenn.dev/microsoft/articles/powershell-linux-key-bindings) によると、

```powershell
Import-Module PSReadline
Set-PSReadLineOption -EditMode Emacs
```

でよいとのこと。ただし、これはセッションを終了すると消えてしまう。起動時に自動的に実行させるためには

```powershell
mkdir (Split-Path -Path $profile)
vim $profile
```

で起動する時のコードを登録する。
( くわしくは「[プロファイルについて - PowerShell | Microsoft Learn](https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_profiles?view=powershell-7.4)」にあるそうだが、面倒なので、あまり本気で読んでいない)

#### スクリプトを PowerShell 7.4 以上でしか実行できないようにする

たとえば、例のバックアップスクリプトは PowerShell 5.1 で実行されると、またマシンが凍ることになる。安全装置を入れておきたい。

```
If ( (Get-Host).Version -lt [System.Version] '7.4.0' ){
    Write-Host "Please use PowerShell 7.4 or later"
    exit 1
}
```

を先頭に書いとこう。

### [nyagos] 拡張子 .ps1 との関連付け

.nyagos の Lua コードを修正。PowerShell 7 が存在しそうな時だけ、ps1 で終わるコマンド名の前に `pwsh` を挿入するようにした。

```lua
if string.find(nyagos.env.PATH,"PowerShell\\7",1,true) then
    share._setsuffix("ps1","pwsh")
end
```
