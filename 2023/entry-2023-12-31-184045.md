Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2023/12/31/184045
Rem: App-Edited: 2024-02-09T01:06:27+09:00
Rem: Draft: yes
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189071306910
Rem: Published: 2023-12-31T18:42:42+09:00
Category: PowerShell
Updated: 2023-12-31T18:40:45+09:00
Title: 「rclone cat GIGABYTESFILE.tar.zst | zstd -d」 で Decoding error (36) が出る
---
マインクラフトのバックアップスクリプトに最近、リストアテストを入れたんだけど、たまに `zstd -d` 部分で

```
/*stdin*\ : Decoding error (36) : Data corruption detected
```

が出たりする。

+ 同じバックアップに対するリストアテストでも、タイミングによって発生する場所が違ったり、発生しなかったりする。
+ パイプラインで `rclone cat ... | zstd -d |` としているが、一旦ローカルにダウンロードしてから `zstd -d < ローカルファイル` とするとエラーはおきない。
+ zstd の issues には定期的に同エラーの issue が起案されるが、ストレージが悪いんちゃうの？とか言われてクローズされてゆく

バックアップスクリプトは以下のとおり。今は PowerShell 7.4.0 (pwsh) を使っている。

```ps1
If ( (Get-Host).Version -lt '7.4.0' ){
    Write-Host "Please use PowerShell 7.4 or later"
    exit 1
}

function Backup($world,$remote_dir) {
    $archive = "/minecraft-" + $world + "-" + (Get-Date -Format "yyyyMMdd") + ".tar.zst"
    $archive = $remote_dir + $archive
    $cwd = (Join-Path $env:APPDATA ".minecraft\saves")
    if ( -not (Test-Path $cwd) ){
        Throw "$cwd does not exist"
    }
    tar -C $cwd -cvf - $world | zstd | rclone rcat $archive
    rclone cat $archive | zstd -d | verifyarc -C $cwd -
}

Backup "Demo_World" "sakura:(中略)"
```

[verifyarc] は拙作の検証プログラムだが、エラーはコイツではなく、パイプラインのより上流の zstd -d で発生しているので、おそらく問題とは関係ない。

[verifyarc]: https://github.com/hymkor/verifyarc

でも、zstd -d を `gzip -d` に直してみると…

```
gzip.exe": stdin: invalid compressed data--format violated
```

どうやら、zstd が悪いというわけでもないようだ。

うーむ、rclone で FTP サーバーに連結して、数GBのファイルをやりとりするのがそもそも無茶なんかなー。一旦、ローカルに .tar.zst ファイルを追いて、それを出し入れすべきか…

#### (追記)

さくらポケットのウェブ画面からダウンロードし、それに対して

```
gzip -d < ….tar.gz | verifyarc -C %APPDATA%\.minecraft\saves -
```

とやる分には全くエラーがでない。つまり、バックアップ自体はパイプライン経由でも成功しているが、リストアはパイプライン経由では失敗しているようだ。実用上は御の字なんだけど、原因がはっきりしないのが、ちょっと嫌だなぁ。

#### (追記2)

backup-Demo\_world.ps1 のパイプライン部分を

```
    cmd.exe /c "tar -C $cwd -cvf - $world | zstd | rclone rcat $archive"
    cmd.exe /c "rclone cat $archive | zstd -d | verifyarc -C $cwd -"
```

としてみた。結果：

```
ARCHIVE: [OK] Demo_World/region/r.1.8.mca
/*stdin*\ : Decoding error (36) : Data corruption detected
ARCHIVE: [DIFFER] Demo_World/region/r.1.9.mca
2024/01/09 20:21:25 ERROR : minecraft-Demo_World-20240109.tar.zst: Failed to send to output: write /dev/stdout: The pipe has been ended.
2024/01/09 20:21:27 Failed to cat: write /dev/stdout: The pipe has been ended.
```

別に PowerShell のパイプラインが悪かったというわけでもなさそうだ。とほほ

#### (追記3)

verify 部分の `rclone cat` を `curl` にしてみると、ひとまずエラーがでなくなった。

```ps1
$USER = "(ユーザ名)"
$PASS = "(パスワード)"
$DIR = "(ディレクトリ)"

If ( (Get-Host).Version -lt '7.4.0' ){
    Write-Host "Please use PowerShell 7.4 or later"
    exit 1
}

function Backup($world) {
    $fname = "minecraft-" + $world + "-" + (Get-Date -Format "yyyyMMdd") + ".tar.zst"
    $fullpath = $DIR + "/" + $fname
    $url = "sakura:" + $fullpath

    $cwd = (Join-Path $env:APPDATA ".minecraft\saves")
    if ( -not (Test-Path $cwd) ){
        Throw "$cwd does not exist"
    }
    tar -C $cwd -cvf - $world | zstd | rclone rcat $url
    curl --user ${USER}:${PASS} ftp://wifky.sakura.ne.jp/$fullpath | zstd -d | verifyarc -C $cwd -
}

Backup "Demo_World"
```

対照実験の結果として、tar / verifyarc / zstd / gzip には問題がないが、ftp サーバーに対して、`rclone cat` でギガクラスのファイルをダウンロードした場合、問題が出るということになるようだ。

#### (追記4)

PowerShell が次のようなエラーを出していた。

```
FILESYS: [OK] Demo_World\DIM-1\poi\r.4.2.mca
ResourceUnavailable: C:\Users\hymkor\Share\cmds\backup-Demo_world.ps1:21
Line |
  21 |      curl --user ${USER}:${PASS} ftp://wifky.sakura.ne.jp/$fullpath |  …
     |      ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
     | Program 'zstd.exe' failed to run: パイプを閉じています。At
     | C:\Users\hymkor\Share\cmds\backup-Demo_world.ps1:21 char:70 + …  ${USER}:${PASS}
     | ftp://wifky.sakura.ne.jp/$fullpath | zstd -d | verif … +
     | ~~~~~~~.
```

これは zstd -d が全てを出力して、それが全て verifyarc が読みとる前に verifyarc が終了してしまったために発生したエラーだと思われる。verifyarc は特にエラーなく終了しているところを見ると、特に読み取る必要のない tar のフッタか何かが残っていたのだろう。

対策として、verifyarc で標準入力から tar を読み込む場合、

```go
    defer io.Copy(io.Discard,os.Stdin)
```

の一文を入れて、標準入力を最後まで読み切るようにした。

PowerShell の方は問題なかったが、送信が rclone、受信が curl というのも対称的ではないので、送受信両方とも curl で書き変えた。また、curl は標準エラー出力に進捗表示をするが、tar や verifyarc の出力と重なって表示が崩れるので、`-s` (silent option) で出力を抑制するようにした。

```ps1
$USER = "…"
$PASS = "…"
$DIR = "…"

If ( (Get-Host).Version -lt '7.4.0' ){
    Write-Host "Please use PowerShell 7.4 or later"
    exit 1
}

function Backup($world) {
    $fname = "minecraft-" + $world + "-" + (Get-Date -Format "yyyyMMdd") + ".tar.zst"
    $fullpath = $DIR + "/" + $fname

    $cwd = (Join-Path $env:APPDATA ".minecraft\saves")
    if ( -not (Test-Path $cwd) ){
        Throw "$cwd does not exist"
    }
    tar -C $cwd -cvf - $world | zstd | curl -s -T - --user ${USER}:${PASS} ftp://wifky.sakura.ne.jp/$fullpath
    curl -s --user ${USER}:${PASS} ftp://wifky.sakura.ne.jp/$fullpath | zstd -d | verifyarc -C $cwd -
}

Backup "Demo_World"
```

+ (続き) [(謎) FTPサイトでダウンロードすると巨大ファイルがよく壊れる - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2024/02/08/151703)
+ (さらに続き) [やばいFTP屋さん（FTPは予想以上に信頼性が低い） - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2024/02/08/201103)
