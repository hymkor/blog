Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/02/05/075134
Rem: App-Edited: 2024-02-05T07:51:34+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189080674459
Rem: Published: 2024-02-05T07:51:34+09:00
Category:
Updated: 2024-02-05T07:51:34+09:00
Title: 曖昧文字幅取得
---
過去のブックマークの消化をしていると、次のようなページを確認しました。

+ [端末の文字幅問題の傾向と対策 | IIJ Engineers Blog](https://eng-blog.iij.ad.jp/archives/12576)

これで目をひいたのが Reline のトコ。Unicode の曖昧文字幅：環境によって文字の幅が2セルか1セルか分からない文字の幅を計測するコードです。

行頭へ移動してから、&#x25BD; (U+25BD) を表示した後、カーソル位置を `ESC[6n` で取得して幅を計測するという方式を使っているとあります。

カーソル位置を取得するANSIエスケープシーケンス `ESC[6n` の存在は一応知っていたんですが、大掛かりすぎて実用にならないと勝手に思い込んでいました。おもしろいなーと思って、自分も Go言語で書いてみました。

+ [hymkor/go-cursorposition: Query and display the cursor position with ESC\[6n](https://github.com/hymkor/go-cursorposition)

文字幅を得る関数 AmbiguousWidth を提供するとともに、その過程でカーソル位置を得る処理も Request という関数にしました。パッケージは汎用性のある Request の方を主役にしましたが。

ちょっと迷った点：

+ `ESC[6n` を送信する先を標準エラーにするか、パラメーターにするか？  
    →  パラメータにした
+ `ESC[6n` を送信した後、`ESC[(行位置);(桁位置)R` を受信するため、端末を RAWモードにするコードを含めるか否か。含める場合 ["golang.org/x/term"](https://pkg.go.dev/golang.org/x/term) を使うか、それのラッパーの["github.com/hymkor/go-windows1x-virtualterminal/keyin"](https://pkg.go.dev/github.com/hymkor/go-windows1x-virtualterminal/keyin) にするか？  
    → 含めないようにした (  Example で、呼び出し元で RAW モードにするコード例を出した )

これ `ESC[(行位置);(桁位置)R` に加え、改行コードも端末側から出してくれたら、RAW モードに切り替えなくても済むのに、なんでそういう仕様にしたんでしょうねぇ &gt; VT100