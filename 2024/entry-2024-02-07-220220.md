Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/02/07/220220
Rem: App-Edited: 2024-02-09T01:07:10+09:00
Rem: Draft: yes
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189081370043
Rem: Published: 2024-02-07T22:12:00+09:00
Category: go
Updated: 2024-02-07T22:02:20+09:00
Title: Go 1.22 で "syscall" の deprecated が外された件
---
Go 1.22 がリリースされました。

+ [Go 1.22 Release Notes - The Go Programming Language](https://go.dev/doc/go1.22)

Go 1.11 で deprecated とされた `"syscall"` パッケージですが、1.22 で deprecated 扱いが外されたようです。

> *syscall*
> 
> The syscall package has been frozen since Go 1.4 and was marked as deprecated in Go 1.11, causing many editors to warn about any use of the package. However, some non-deprecated functionality requires use of the syscall package, such as the os/exec.Cmd.SysProcAttr field. To avoid unnecessary complaints on such code, the syscall package is no longer marked as deprecated. The package remains frozen to most new functionality, and new code remains encouraged to use golang.org/x/sys/unix or golang.org/x/sys/windows where possible.

(以下機械翻訳)

> syscall パッケージは Go 1.4 以降凍結されており、Go 1.11 では非推奨としてマークされたため、多くの編集者がこのパッケージの使用について警告を発しています。ただし、非推奨でない一部の機能では、os/exec.Cmd.SysProcAttr フィールドなど、syscall パッケージの使用が必要です。このようなコードに関する不必要な苦情を避けるために、syscall パッケージは非推奨としてマークされなくなりました。パッケージはほとんどの新機能に対して凍結されたままであり、新しいコードでは可能な限り golang.org/x/sys/unix または golang.org/x/sys/windows を使用することが推奨されます。

この `"syscall"` 復活の原因となった `SysProcAttr` ですが、実は nyagos で(場所が少々違いますが)現役で使っていたりします。

Go言語から Windows のOSコマンドを呼ぶ際に、Go言語のライブラリは UNIX系のAPIどおりに文字列配列でコマンドへの引数を引き渡します。ですが、Windows の API (CreateProcessW)ではコマンド引数を一枚板の一個の文字列としてしか受けとれません。なので、通常はライブラリで文字列配列を空白でつないだ一つの文字列に変換する処理を行います。

ここでネックになるのは二重引用符の扱いです。普通のライブラリは引数の中に空白などが含まれていたら二重引用符で囲み、そうでなければ二重引用符をつけないという動作を行います。

+ Go言語側：「`[]string{"param1","param 2","\"param\""}`」という文字列配列
+ OSに渡される時：「`param1 "param 2" "\"param\""`」という1個の文字列

ところが Windows には二重引用符の有無で引数の種類を判断する標準コマンドがあったりします。

```
C:> find curl *.bat
FIND: パラメーターの書式が違います

C:> find "curl" *.bat

---------- AUTH.BAT

---------- BYCURL.BAT
curl --user %USER%:%PASS% ftp://%SERVER%/%FULLPATH% > bycurl-%NAME%

---------- BYRCLONE.BAT
```

つまり、引数に空白が含まれない時でも逢えて二重引用符を付けなくてはいけないというシチュエーションが存在します。こういった場合、Go言語のライブラリの「空白などを含まない場合は二重引用符をつけず、空白を含む場合は二重引用符で囲む」というデフォルトルールが邪魔になってしまいます。逆にOS の実行ファイル呼び出しのAPI (CreateProcessW) に渡す一枚板の引数を、下手にライブラリで加工させず、呼び出すユーザ側で直接指定できた方が都合がよいです。`SysProcAttr` は、まさにそのためにあるパラメータで、OS個別のオプションを指定するために存在しています。

nyagos で使っているのは `os/exec.Cmd.SysProcAttr` ではなく、`os.ProcAttr.Sys` ですが、これに設定する型は同じ `*syscall.SysProcAttr` です。これの .Cmdline フィールドに一枚板化されたパラメータを設定できるようになっているのです。

[internal/shell/interpreter\_windows.go](https://github.com/nyaosorg/nyagos/blob/444f2681090a106c78df1c7142a590c4327ca267/internal/shell/interpreter_windows.go#L92)
```
procAttr := &os.ProcAttr{
    Env:   cmd.DumpEnv(),
    Files: cmd.Stdio[:],
    Sys:   &syscall.SysProcAttr{CmdLine: cmdline},
}
```

[internal/shell/interpreter.go](https://github.com/nyaosorg/nyagos/blob/444f2681090a106c78df1c7142a590c4327ca267/internal/shell/interpreter.go#L398)
```
process, err := os.StartProcess(name, args, procAttr)
```

このフィールドのおかげで nyagos は CMD.EXE と等価なコマンド呼び出しができるようになっていましたが、その反面 deprecated なモジュールの import をしているという気持ち悪さがありました。

ということで、1.22 にて `"syscall"` の deprecated 指定が晴れて外れ、めでたしめでたしです。ですが…

+ Go のツールで、今まで `"syscall"` 使っているから警告やエラーを出されたことがない  
  (どういうツールを使えば出るんでしょう？)
+ nyagos は Windows7,8,Server2008対応のため、 Go 1.20 にバージョン固定しており、実は恩恵はない

うーん、どうなんでしょうかねぇ
