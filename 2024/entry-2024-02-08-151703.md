```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/02/08/151703
Rem: App-Edited: 2024-02-09T01:05:35+09:00
Rem: Draft: yes
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189081546473
Rem: Published: 2024-02-08T15:17:03+09:00
Category:
Updated: 2024-02-08T15:17:03+09:00
Title: (謎) FTPサイトでダウンロードすると巨大ファイルがよく壊れる
```
昨年末にジタバタしていた、バックアップのベリファイがうまくゆかないといっていた件：

+ [「rclone cat GIGABYTESFILE.tar.zst | zstd -d」 で Decoding error (36) が出る - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2023/12/31/184045)

当初は FTP サイトに対する `rclone cat` に不具合があるのでは？とみていた。
今日、issue を立てるため、改めて検証した。

**auth.bat** … 認証情報などを書いておく共通バッチファイル
```auth.bat
@set "SERVER=伏伏伏伏"
@set "USER=伏伏伏伏"
@set "PASS=伏伏伏伏"
@set "DIR=伏伏伏伏/伏伏伏伏/伏伏伏"
@set "NAME=minecraft-Demo_World-20240126.tar.zst"
@set "FULLPATH=%DIR%/%NAME%"
```

**bycurl.bat** … curl でダウンロードするバッチ
```bat
@setlocal
@call auth.bat
curl --user %USER%:%PASS% ftp://%SERVER%/%FULLPATH% > curl-%NAME%
@endlocal
```

**byrclone.bat** … rclone でダウンロードするバッチ
```bat
@setlocal
@call auth.bat
rclone cat sakura:%FULLPATH% > rclone-%NAME%
@endlocal
```

ところが

```
$ zstd -d < try1-curl-minecraft-Demo_World-20240126.tar.zst > nul
/*stdin*\ : Decoding error (36) : Data corruption detected
exit status 1

$ zstd -d < try1-rclone-minecraft-Demo_World-20240126.tar.zst > nul

$ zstd -d < try2-curl-minecraft-Demo_World-20240126.tar.zst > nul
/*stdin*\ : Decoding error (36) : Data corruption detected
exit status 1

$
```

curl は二回やってもダメ。むしろ、rclone の方が壊れてない。どういうこと！？
（※当初は１回ずつダウンロードするつもりが、意図どおりにゆかず、何回もダウンロードをトライせざるを得ない状況になったので、ファイル名の頭に回数として `tryN-` をつけた形にリネームしている）

```
$ wildcard md5sum *.zst
6de2e55320c8739269c8d297b4b13015  try1-curl-minecraft-Demo_World-20240126.tar.zst
150d9790486cc4db0858002e925bda2e  try1-rclone-minecraft-Demo_World-20240126.tar.zst
54648def84df48e9462d498d06c13e53  try2-curl-minecraft-Demo_World-20240126.tar.zst
```

チェックサムは、バラバラ

```
$ dir *.zst
 ドライブ C のボリューム ラベルがありません。
 ボリューム シリアル番号は 0229-7A5A です

 C:\Users\hymkor\tmp\rclone のディレクトリ

2024/02/07 水  20:31     3,905,737,011 try1-curl-minecraft-Demo_World-20240126.tar.zst
2024/02/08 木  05:30     3,905,737,011 try1-rclone-minecraft-Demo_World-20240126.tar.zst
2024/02/08 木  11:48     3,905,737,011 try2-curl-minecraft-Demo_World-20240126.tar.zst
               3 個のファイル      11,717,211,033 バイト
               0 個のディレクトリ  636,634,812,416 バイトの空き領域
```

サイズは、あたかも正常にダウンロードしたかのように一致(しているだけ)。**どういうこと！？**

サーバー側の問題なのか、通信経路の問題なのか…どっちなんじゃろ( よくアップロード時に壊れないもんだな )

(続き): [やばいFTP屋さん（FTPは予想以上に信頼性が低い） - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2024/02/08/201103)
