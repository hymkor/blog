```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/02/23/144823
Rem: App-Edited: 2024-03-23T12:10:42+09:00
Rem: Draft: yes
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189085486463
Rem: Published: 2024-02-23T14:48:23+09:00
Category:
Updated: 2024-02-23T14:48:23+09:00
Title: マイクラデータのバックアップの落ち着きどころ
```
+ [バックアップツール restic おためし中 - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2024/02/21/111146)

マイクラデータのバックアップをしてみたところ二回目以降がかなり速いので、もうこれを採用することにした。その為の環境変数の設定や、バッチファイルを用意する。

#### .nyagos 追加行

```lua
nyagos.env.RESTIC_REPOSITORY=nyagos.pathjoin(nyagos.env.USERPROFILE,"OneDrive\\Documents\\minecraft-backups")
nyagos.env.RESTIC_PASSWORD="********"
```

環境変数の定義は、バッチファイルの方に書いてもよかったのだが、コマンドラインで直接 `restic snapshots` などでバックアップ一覧を見る場合もあるので、こちらに書いておくことにした。

#### Backup-minecraft.cmd

バックアップをとって、過去3回以前の差分は捨てるようにする

```bat
setlocal
    pushd "%APPDATA%\.minecraft"
        restic.exe backup saves
        restic.exe forget --keep-last 3 --prune
    popd
endlocal
```

#### 念のためテスト

restic を疑っているわけではないが、万が一「全バックアップは初回のみで、以降は全て差分バックアップ。初回を削除すると差分が無意味になる」という方式だったりすると、目もあてられないので。

比較は拙作の [verifyarc](https://github.com/hymkor/verifyarc) を使う。このツール、アーカイブファイル vs ファイルシステムという比較しかできないので、`restic restore` で展開したファイル一式を一旦tar化してから、比較する。

```
C:> cd ~/tmp
C:> restic.exe restore -t . 19f2d6d5
C:> tar cf - saves | verifyarc.exe -C %APPDATA%\.minecraft -

ARCHIVE: [OK] saves/TEST/icon.png
ARCHIVE: [OK] saves/TEST/level.dat
ARCHIVE: [OK] saves/TEST/level.dat_old
    :中略
ARCHIVE: [OK] saves/Demo_World/advancements/17a2da24-6445-38a2-96f6-e635896edf81.json
ARCHIVE: [OK] saves/Demo_World/advancements/e6f32b0a-08ea-4a32-9034-7eabfb444178.json
FILESYS: [OK] saves\TEST\DIM-1\data\raids.dat
FILESYS: [OK] saves\TEST\DIM-1\data\raids_nether.dat
FILESYS: [OK] saves\TEST\data\raids.dat
    :中略
FILESYS: [OK] saves\TEST\session.lock
FILESYS: [OK] saves\TEST\stats\e6f32b0a-08ea-4a32-9034-7eabfb444178.json

C:>
```

verifyarc のログを見る限りでは、ARCHIVE 側も FILESYS 側両方とも [OK] がそろっており、問題なさそうだ。

+ ARCHIVE: 行 → アーカイブ(ここでは %APPDATA%/.minecraft/saveas 以下のファイル)を、ファイルシステム(~/tmp/saves )のファイルと比較して差異がなかったら [OK]
    + ここで [NG] が出ると、アーカイブが壊れている
+ FILESYS: 行 → アーカイブのファイルが一つでも展開されたディレクトリ以下のファイルがちゃんと、アーカイブ側にあれば [OK]
    + ここで [NG] が出ると、アーカイブ作成時にファイルの指定漏れがある「可能性がある」

よしよし
