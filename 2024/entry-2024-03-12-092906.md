```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/03/12/092906
Rem: App-Edited: 2024-03-12T09:29:06+09:00
Rem: Draft: yes
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189090032336
Rem: Published: 2024-03-12T01:02:25+09:00
Category:
Updated: 2024-03-12T01:02:25+09:00
Title: SysProcAttr のフィールドの意味
```
"syscall" パッケージ：

```
func StartProcess(argv0 string, argv []string, attr *ProcAttr) (pid int, handle uintptr, err error)
```

```
type ProcAttr struct {
    Dir   string
    Env   []string
    Files []uintptr
    Sys   *SysProcAttr
}

type SysProcAttr struct {
    HideWindow                 bool
    CmdLine                    string // used if non-empty, else the windows command line is built by escaping the arguments passed to StartProcess
    CreationFlags              uint32
    Token                      Token               // if set, runs new process in the security context represented by the token
    ProcessAttributes          *SecurityAttributes // if set, applies these security attributes as the descriptor for the new process
    ThreadAttributes           *SecurityAttributes // if set, applies these security attributes as the descriptor for the main thread of the new process
    NoInheritHandles           bool                // if set, no handles are inherited by the new process, not even the standard handles, contained in ProcAttr.Files, nor the ones contained in AdditionalInheritedHandles
    AdditionalInheritedHandles []Handle            // a list of additional handles, already marked as inheritable, that will be inherited by the new process
    ParentProcess              Handle              // if non-zero, the new process regards the process given by this handle as its parent process, and AdditionalInheritedHandles, if set, should exist in this parent process
}
```

このうちの ThreadAttributes に設定する値を WINAPI の

+ InitializeProcThreadAttributeList
+ UpdateProcThreadAttribute

で属性を設定する。これらは golang.org/x/sys に該当のセットがあって

```
threadAttr,err := NewProcThreadAttribute(count)
    ：
threadAttr.Update()
threadAtrr.List()
```

+ ProcThreadAttributeList は、`PROC_THREAD_ATTRIBUTE_LIST` を表すプレースホルダータイプです。
+ `*ProcThreadAttributeList` を作成するには、`NewProcThreadAttributeList` を使用し、`ProcThreadAttributeListContainer.Update` で更新し、`ProcThreadAttributeListContainer.Delete` を使用してメモリを解放し、`ProcThreadAttributeListContainer.List` を使用してリスト自体にアクセスします。

```
type StartupInfoEx struct {
	StartupInfo
	ProcThreadAttributeList *ProcThreadAttributeList
}
```

sample:

https://github.com/golang/go/issues/44005#issuecomment-770473222


```
startupInfo := new(windows.StartupInfoEx)
startupInfo.Cb = uint32(unsafe.Sizeof(*startupInfo))
startupInfo.ProcThreadAttributeList, err = windows.NewProcThreadAttributeList(1)
if err != nil {
    log.Fatalf("Could not create proc thread attribute list: %v", err)
}
err = startupInfo.ProcThreadAttributeList.Add(windows.PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, unsafe.Pointer(&shellProcess), unsafe.Sizeof(shellProcess))
if err != nil {
    log.Fatalf("Could not set parent process handle: %v", err)
}

processInfo := new(windows.ProcessInformation)
err = windows.CreateProcess(notepad16, notepad16, nil, nil, false, windows.CREATE_NEW_CONSOLE|windows.EXTENDED_STARTUPINFO_PRESENT, nil, nil, &startupInfo.StartupInfo, processInfo)
if err != nil {
    log.Fatalf("Could not create process: %v", err)
}
windows.CloseHandle(processInfo.Process)
windows.CloseHandle(processInfo.Thread)
```
