```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/05/30/082549
Rem: App-Edited: 2024-06-13T23:33:57+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189110310206
Rem: Published: 2024-05-30T09:06:56+09:00
Category:
Updated: 2024-05-30T08:25:49+09:00
Title: 【解説】ターミナル用 DBクライアントSQL-Bless v0.12.0 を公開しました
```
+ 前回→ [【解説】ターミナル用データベースクライアント SQL-Bless で CSVI をページャとして使うようにしてみました - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2024/05/10/205714)

[Release v0.12.0 · hymkor/sqlbless](https://github.com/hymkor/sqlbless/releases/tag/v0.12.0)

v0.10.1 では SELECT の結果を [Csvi] でスプレッド風に表示させるようにしたわけですが、スプレッド風に閲覧できるなら、編集もしたいですよね。できるようにしました。それが `EDIT` 文です。

[Csvi]: https://github.com/hymkor/csvi

#### EDIT 文 (v0.11.0)

```
EDIT table-name [WHERE conditions]
```

このコマンドは `EDIT` 部分を `SELECT * FROM` に置き換えた結果を [Csvi] で編集します。編集した後 `c` を押下すると `Apply Changes [y/n]` と問い合わせてくるので `y` を選択します。すると、変更内容を SQL に置き変えて実行するかを聞いてくるので `y` を選択すると、その SQL を実行します。

[f:id:zetamatta:20240530082443g:plain]

注意点としては主キーが不明なので、行を指定する条件として、変更前の全列の値を指定していることです。そのため、全ての列が一致する行が複数あると、複数行更新されてしまいます。しかしながら、それが発生するのは主キーや一意制約が一つも存在しないテーブルだけなので、問題ないかと考えています。

あと、きちんと WHERE 句を列を指定するには、更新前後の値をそのデータベースの適切な書式のリテラルで表現しなくてはいけませんでした。文字列や数字であればよいのですが、一番のネックは日付・時間型でした。これがデータベースの種類ごとにバラバラで一苦労でした。

| RDBMS | 種類 | 型 | \<2006年1月2日15時4分5秒\>を表す表現 |
|----------|-----|-----|---------|
| Oracle | 日時 |DATE | `TO_DATE('2006-01-02 15:04:05','YYYY-MM-DD HH24:MI:SS')`
| PostgreSQL | 日時 | TIMESTAMP | `TIMESTAMP '2006-01-02 15:04:05'` [^1]
|                  | 日付 | DATE | `DATE '2006-01-02'`
|                  | 時刻 | TIME | `TIME '15:04:05'`
| SQL Server | 日時 | DATETIME | `CONVERT(DATETIME,'2006-01-02 15:04:05',120)` [^2]
|                  | 日付 | DATE | `CONVERT(DATE,'2006-01-02',23)`
|                  | 時刻 | TIME | `CONVERT(TIME,'15:04:05',108)`
| MySQL | 日時 |DATETIME | `STR_TO_DATE('2006-01-02 15:04:05','%Y-%m-%d %H:%i:%s')` [^3]
|  | 日付 | DATE | `STR_TO_DATE('2006-01-02','%Y-%m-%d')`
|  | 時刻 | TIME | `STR_TO_DATE('15:04:05',%H:%i:%s')`

[^1]: https://www.postgresql.jp/document/9.2/html/datatype-datetime.html
[^2]: https://learn.microsoft.com/ja-jp/sql/t-sql/functions/cast-and-convert-transact-sql
[^3]: https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html

実は多くの RDBMS では１秒未満を表現可能な型が別途あったりしましたが、この時点での対応量がかなり大きかったので、今回の修正は見送りました。

#### SQLite3 対応 (v0.12.0)

[issue](https://github.com/hymkor/sqlbless/issues/1) で依頼をいただいたので、対応しました。元々、SQLite3 は対応したいなと思っていたんですが、もう既に 4-DB も対応したいので、ちょっとしんどいかなと躊躇していたので、背中を押された形になります。

問題はドライバーです。デファクトスタンダードになっている [mattn/go-sqlite3] は "cgo" を使わないといけないので、ビルド要件があがります。そんなことを考えていたところ、 [glebarez/go-sqlite] という Pure-Go なドライバーがあると教えていただきました。Windows / Linux で使用実績があるとのことで、試してみたところ、Windows-386(32bit) というアーキテクチャの時のみビルドに失敗します。

[mattn/go-sqlite3]: https://github.com/mattn/go-sqlite3
[glebarez/go-sqlite]: https://github.com/glebarez/go-sqlite

確認したところ、[glebarez/go-sqlite] は[modernc.org/sqlite] というパッケージのラッパーらしいのですが、その[modernc.org/sqlite] の方が windows-386 という組合せをサポートしていないようです。そっかー

[modernc.org/sqlite]: https://pkg.go.dev/modernc.org/sqlite

ならば原点に戻って、[mattn/go-sqlite3] でトライです。すると…今度は Windows 上での Linux 向けバイナリ作成のクロスビルドが通りません！ [TDM-GCC] では無理だったかー

[TDM-GCC]: https://jmeubank.github.io/tdm-gcc/

仕方がないので、両方を併用する形にしました。結果こうです

| OS      | 386                 | amd64                |
|---------|---------------------|----------------------|
| Linux   | [glebarez/go-sqlite] | [glebarez/go-sqlite] |
| Windows | [mattn/go-sqlite3]  | [glebarez/go-sqlite] |

問題としては [glebarez/go-sqlite] は、"database/sql" での識別子となる ドライバー名が "sqlite"、[mattn/go-sqlite3] では "sqlite3" になっている点がありました。

これについては、glebarez/go-sqlite の方で「[ドライバー名を sqlite3 にするプルリクエスト]( https://github.com/glebarez/go-sqlite/pull/150)」がマージされているのを発見しました。どうやら、`import _ "github.com/glebarez/go-sqlite/compat"` と import すればよいだけのようです。そういうのは README に書いておいてほしかった…

あと課題は `EDIT` 文で用いる、日付・時刻のリテラル表現です。確認すると、SQLite3 の列の型には日付・時間型はないようです。値にはあるようですが、基本は文字列表現のようです(Perl 4 みたいだ)。多分、特に対応する必要はないようです。問題が見付かったら、またそのとき対応しましょう。


#### テーブルの仕様を表示する DESC 文 (v0.3.0)

テーブルの仕様を表示するコマンドが欲しいという[issue](https://github.com/hymkor/sqlbless/issues/2)を頂戴しました。あれ？既に DESC 文があるはずなのに？と思って説明したら、「それ、README に書いてあります？」いや、当然書いて…ない！抜けてた！

DESC文は [v0.3.0](https://github.com/hymkor/sqlbless/releases/tag/v0.3.0) の時から実装していたコマンドで

- `DESC` のみで、テーブルの一覧を表示
- `DESC テーブル` で、指定したテーブルのカラム構成などを表示

します。えぇ、これ、各データベースごとに問い合わせる SQL が違っていて、実装には結構手間がかかったのに…ドキュメントに書いてなかったとは…えぇ…(ショック)

#### YouTube に解説動画を作っていただけました

v0.10 時点での仕様ベースですが、YouTube に解説動画を作っていただけました。先に言及したissue 2件を起案くだだった[@emisjerry](https://github.com/emisjerry)さんによるものです。やだ、うれしい！

- [コマンドラインデータベースツール SQL-Bless と CSVテキストファイルエディタ CSVI - YouTube](https://www.youtube.com/watch?v=_cxBQKpfUds)

日本語のキャプションがついているのですが、台湾の方の動画です。字幕設定で日本語を指定すれば我々にも理解できる内容です。ありがとうございます。

#### まとめ

`EDIT`文の実装と、SQLite3 のサポートによって、SQL-Bless はターミナル用データベースクライアントとしては他のどのツールよりも使い易くなったのではないかと思います。これが GUI のものも含めると、Microsoft Access とか [A5:SQL Mk-2](https://a5m2.mmatsubara.com/) などが入ってくるため、ちょっと勝ち目がありませんけどね。

SQL-Bless は自分の技術：

- [NYAGOS](https://github.com/nyaosorg/nyagos) の [ReadLine](https://github.com/nyaosorg/go-readline-ny)
- [Csvi] などの TUI ツールのエディター機能
- 仕事で学んだデータベース技術

の集大成みたいなところがあります。これの完成といえる v0.12.0 が、虹夏ちゃんと早見沙織さんの誕生日：5月29日にリリースできたのは、この上ない喜びです。
