Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/06/30/042435
Rem: App-Edited: 2024-06-30T22:11:22+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189118126124
Rem: Published: 2024-06-30T04:34:14+09:00
Category: curl jq
Updated: 2024-06-30T04:24:35+09:00
Title: curl と jq で、GitHub レポジトリの Contributor list を作る
---
### (1) issue の起案者の一覧を GitHub からダウンロード

```
curl "https://api.github.com/repos/USERNAME/REPOSITORY/issues?state=all" > issues.json
```

+ Open/Close 問わずに取得したいので、URL の `?state=all` を追加する
+ そのままだと1ページ目だけしか出ない。2ページ名を取得するには `&page=2` を URL に追加する

### (2) JSON から issue 番号とユーザ名、ユーザページ名を抽出

```
cat issues.json | jq -r ". | map(\"#\"+(.number|tostring)+\" [\"+ .user.login + \"](\"+ .user.html_url + \")\") | join(\"\r\n\")"
```

→ `#NN [@USERNAME](https://github.com/USERNAME)` という行形式で取得できる

+ 基本的にはパイプライン言語なので、入力はパイプライン記号 `|` の左に書く
+ `.` はよく分からないが、カレントオプジェクトとでも言えばよさそう
+ map は Perl や Ruby の map に似ている。ここでは issue の配列を、起案ユーザについての情報をまとめた文字列の配列に変換する
+ 変換した文字列の配列を join で連結して1文字列にする
+ そのままだと `"..\r\n..."` といった形で表示されるので、 `-r` オプションをつけて、生文字列化して表示される

### (追記) ~~Windows~~ CMD.EXE ではコード中の \\" がきついので ' を使えるようにする

[single2double.exe](https://github.com/hymkor/single2double) というツールを作った。

```
cat issues.json | single2double.exe jq -r ". | map('#'+(.number|tostring)+' ['+ .user.login + ']('+ .user.html_url + ')') | join('\r\n')"
```

引数中に含まれる`'` を `\"` に変えて、第一引数のコマンドを呼び出しているだけ

### (追記) PowerShell だと、UNIX同様の引用符が使えますねぇ

```
Get-Content issues.json | jq -r '. | map("#"+(.number|tostring)+" ["+ .user.login + "]("+ .user.html_url + ")") | join("\r\n")'
```

ただし、PowerShell は外部コマンドとのパイプラインのやりとりをANSI(MBCS)とみなす。今回はANK文字だけなので問題ないが、リダイレクト、もしくは jq から直接読み込ませた方がよさそうだ。

```
jq -r '. | map("#"+(.number|tostring)+" ["+ .user.login + "]("+ .user.html_url + ")") | join("\r\n")' issues.json
```

### (追記) jq 完璧に理解した！

長いワンライナーjq はスクリプト化した方がいいね！(あたりまえ)

**issues.jq**
```
[
    .[] |
    select(.labels[] | select(.name == "bug" or .name == "enhancement")) |
    "#"+(.number|tostring)+" ["+ .user.login + "]("+ .user.html_url + ")"
] | join("\r\n")
```

これを `jq -rf issues.jq issues.json` で呼び出す

+ `-f` がスクリプトファイルを指定するオプション
+ issues のうち、ラベルに `bug` か `enhancement` がついているものだけを抽出するようにした
    + 最初、改造方法がまったく検討つかなかったが、ChatGTP に『jq で JSON 文字列「`[ { "labels": [ { "name":"値",...} ] } ]`」の中から "値”が bug もしくは enhanced のものを CSV 化するコードはどう書けばいいでしょうか』と質問して、その回答を元に改造した。見当がつかない課題に対して、とっかかりを得るのにとても便利だ
+ 「展開された複数の値」と配列を今までゴッチャに考えていた。
    + `.[]` は配列を中味の値を複数の値に展開する
        + issues のトップは配列値なので、まずは展開した方が処理しやすい
    + `|` で、展開された値をひとつひとつ個別に処理できる
        + `.` がカレントの値
        + `.NAME` がカレントの値のフィールド
    + `[ 複数の値 ]` で、展開された複数の値をまた1配列に戻すことができる

### (追記) nyagos でもUNIX同様の引用符が使えるようにするアドオン書いた

+ [nyagosでシングルクォートを UNIX 風に使えるようにするフィルタ。"で囲まれていない ' を " にかえ、' で囲まれた " を \" に置換するだけ](https://gist.github.com/hymkor/d2f4ebca9bbe83669cef44f7c9aac668)

### Referneces

+ 本家ホームページ: [jq](https://jqlang.github.io/jq/)
+ [とほほのjq入門 - とほほのWWW入門](https://www.tohoho-web.com/ex/jq.html#command-line)
