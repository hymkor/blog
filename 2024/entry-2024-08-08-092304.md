```header
Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/08/08/092304
Rem: App-Edited: 2024-08-08T09:23:59+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6801883189127968587
Rem: Published: 2024-08-08T09:23:04+09:00
Category: jj jujutsu git DVCS
Updated: 2024-08-08T09:23:04+09:00
Title: jj v0.18-v0.20 で、split サブコマンドの不具合を回避する
```
Git互換の 分散バージョン管理システム [jj](https://github.com/martinvonz/jj) は v0.18 以降、差分編集機能を担うパッケージ [scm-record v0.3.0](https://github.com/arxanas/scm-record/releases/tag/v0.3.0) の不具合を取り込んでしまい、`jj patch` が CR や TAB といった制御文字が含まれる行がまともに表示できないという不具合をかかえ続けている。
( これは Windows で Go を使っている人間は CR も TAB も踏むため、致命的だ )

これを回避するには jj の [v0.17.1](https://github.com/martinvonz/jj/releases/tag/v0.17.1) を使い続けるというのが一番手軽な方法だ。しかし、できれば jj の最新機能を使いたいというユーザのために、最新モジュールで不具合を回避する方法を説明する。

具体的には、scm-record の不具合は最新ソースではなおっていて、それがリンクされていないのが問題なので、最新ソースで scm-record をビルドして、jj からは外部実行モジュールとして利用するようにすればよいだけの話である。

#### (1) Rust をインストールする

使用している OS のパッケージマネージャを使って、Rust をインストールする。

Windows の場合 scoop を使えば、`scoop install rust` `scoop install rustup` で済むはず。

#### (2) scm-record をclone

```
C:> git clone https://github.com/arxanas/scm-record.git
Cloning into 'scm-record'...
remote: Enumerating objects: 1072, done.
remote: Counting objects: 100% (368/368), done.
remote: Compressing objects: 100% (110/110), done.
remote: Total 1072 (delta 291), reused 258 (delta 258), pack-reused 704Receiving objects: Receiving objects: 100% (1072/1072), 321.96 KiB | 4.13 MiB/s, done.

Resolving deltas: 100% (704/704), done.
```

#### (3) scm-diff-editor をビルド

```
C:> cd scm-record\scm-diff-editor

C:> cargo build --release
   Compiling proc-macro2 v1.0.86
   Compiling windows_x86_64_msvc v0.52.5
   Compiling unicode-ident v1.0.12
   : (中略)
   Compiling walkdir v2.5.0
   Compiling scm-diff-editor v0.3.0 (C:\Users\hymkor\src\wor\scm-record\scm-diff-editor)
warning: unused variable: `permissions`
   --> scm-diff-editor\src\lib.rs:225:25
    |
225 |                     let permissions = metadata.permissions();
    |                         ^^^^^^^^^^^ help: if this is intentional, prefix it with an underscore: `_permissions`
    |
    = note: `#[warn(unused_variables)]` on by default

warning: `scm-diff-editor` (lib) generated 1 warning (run `cargo fix --lib -p scm-diff-editor` to apply 1 suggestion)
    Finished release [optimized] target(s) in 1m 08s
C:> 
```

warning が出るが、未使用の変数が存在するという程度のものなので、無視しても差し支えない

#### (4) scm-diff-editor.exe をコピーする

```
C:> copy ..\target\scm-diff-editor.exe (%PATH%の通ったディレクトリ)
```

#### (5) jj で scm-diff-editor.exe を使うよう指定する

```
C:> jj config edit --user
```

もしくは

```
C:> notepad "%APPDATA%\jj\config.toml"
```

で、 次の行を追加する

```
[ui]
diff-editor = "scm-diff-editor"
merge-editor = "scm-diff-editor"

[merge-tools.scm-diff-editor]
program = "scm-diff-editor.exe"
edit-args = ["--dir-diff", "$left", "$right"]
```

これで `jj split` で画面が乱れる問題は解消されるはずである。
