Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/11/02/163847
Rem: App-Edited: 2024-11-02T16:38:47+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6802418398300871066
Rem: Published: 2024-11-02T16:38:47+09:00
Category: powershell github powershell github
Updated: 2024-11-02T16:38:47+09:00
Title:  ギッハブへのリリース スクリプト(PowerShell)
---
GitHub で自分のツールを GitHub へリリースするスクリプト。一応、あげておこう

1. リリースノートのテキストファイルの見出しを読んで、最新のバージョンナンバを得る
2. 次のコマンドを実行するか[Y] / しないか[N] / 全部中止する[Q] かを、質問し、Y が入力されたら実行する
    1. バージョンナンバータグが打たれていなかったら
        + リリースノートの変更のコミット `jj commit -m "bump to バージョン`
        + `git tag バージョンナンバー`
    2. ZIPファイルを作成する `make dist` (Makefile 依存)
    3. `jj branch set master -r `"$version`""`
        ブランチの先頭をバージョンタグを打った場所にする( jj は git と違って、コミットを作っても、勝手に先頭扱いされない)
    4. `jj git push` =`git push` と同じだが、マークされた場所までしか push されない
    5. `git push --tag` 実は jj には同じものはなかったりする
    6. `make release` Makefile側で gh release を実行
    7. `gh browse` ブラウザでリリースのテキストを編集させるため
    8. `make manifest` Makefile側で scoop manifest を更新する
    9. `jj commit -m ....` 更新した manifest をコミット
    10. ``jj branch set master -r `"@-`"``
    11. `jj git push`

関数 `Step-Exec` は他の用途でもいろいろ使い回しが効きそう

```ps1
Set-PSDebug -Strict

function Find-Note {
    foreach ($fn in @("release_note_en.md","release_note_ja.md","release_note.md") ){
        if ( (Test-Path $fn) ){
            return $fn
        }
    }
    Write-Error "release_note not found"
    exit 1
}

function Step-Exec($command) {
    jj log
    While ($true) {
        $ans = (Read-Host ("`r`n$ {0}`r`n[Y]es: execute, [N]o: skip, [Q]uit ?" -f $command))
        if ($ans -eq "q" ){
            exit 1
        }
        if ($ans -eq "n" ){
            return
        }
        if ($ans -eq "y" ){
            Invoke-Expression $command
            return
        }
    }
}

$version = (Get-Content (Find-Note) | Select-Object -first 1)

if ( $version -notmatch "^v\d+\.\d+\.\d+$" ){
    Write-Error ("release_note is not completed: {0}" -f $version)
    exit 1
}
if ( (jj log | Where-Object { $_.Contains($version) } ).Length -lt 1 ){ 
    Step-Exec "jj commit -m `"bump to $version`""
}
if ( (git tag | Where-Object { $_.Contains($version) }).Length -lt 1 ){
    Step-Exec "git tag $version"
}
Step-Exec "make dist"
Step-Exec "jj branch set master -r `"$version`""

Write-Host "`r`n!!!! Proceeding further will cross the Rubicon !!!!`r`n"

Step-Exec "jj git push"
Step-Exec "git push --tag"
Step-Exec "make release"

Write-Host "`r`n**** Update releaes_note and publish ****`r`n"

gh browse

Step-Exec "make manifest"
Step-Exec "jj commit -m `"Update the manifest of the scoop-installer for $version`""
Step-Exec "jj branch set master -r `"@-`""
Step-Exec "jj git push"
```
