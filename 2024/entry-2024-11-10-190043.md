Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/11/10/190043
Rem: App-Edited: 2024-11-12T21:37:59+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6802418398302929053
Rem: Published: 2024-11-12T21:37:59+09:00
Category:
Updated: 2024-11-10T19:00:43+09:00
Title: Windows でコマンドの標準出力・標準エラー出力をぜんぶ記録する話
---
+ [コマンド実行ログをテキストファイルに保存する機能 · nyaosorg/nyagos · Discussion #444](https://github.com/nyaosorg/nyagos/discussions/444)

コマンドの標準出力・エラー出力は、過去 [Expect-Lua for Windows](https://github.com/hymkor/expect) を実装した時に一度検討したことがありました。

普通に標準出力に吐かれるデータをパイプラインで受信すると、改行コードが出力されるまで出力がバッファリングされて動作が止まってしまいます。すると、プロンプトを出して入力待ちをするようなコマンドはハングアップしてしまうという問題がありました。

そうならないためには、パイプラインではなく、OSの疑似端末機能が必要となります。古い Windows にはそういうものはなかったので、かわりに Expect-Lua では画面バッファに直接アクセスして、カーソル行を定期的に監視するようにしていました。

ですが、WSL(Windows SubSystem for Linux)などで Linux 同様のコンソール制御ができるようにするためか、Windows 10 でも疑似端末が使えるようになったようです。

+ [疑似コンソール – Windows デスクトップ - Windows Console | Microsoft Learn](https://learn.microsoft.com/ja-jp/windows/console/pseudoconsoles)

これを Go から利用するパッケージとしては、当初

+ [qsocket/conpty-go: Windows Pseudo Console (ConPTY) implementation for Golang.](https://github.com/qsocket/conpty-go)

がありました。ですが、これは1-疑似端末に対して、1-外部コマンドを起動できるだけなので、複数のコマンドを起動する場合、Expect などではちょっと使いづらく、見送らざるをえませんでした。

その後、nyagos で上記の discussion が立てられた後、改めて検索してみたところ、次のようなパッケージも公開されていました。

+ [aymanbagabas/go-pty: Cross platform Go Pty interface](https://github.com/aymanbagabas/go-pty)

こっちは一つの疑似端末インスタンスから複数の外部コマンドが起動できるようになっています。これは使えそうです。で、今回、試しに端末出力を記録するコマンド [script] の Windows 版を書いてみました[^1]

[^1]: まぁ、これも結果的に1-疑似端末に対して、1-コマンドしか起動させていないのですが…

+ [hymkor/script](https://github.com/hymkor/script)

[script]: https://ja.manpages.org/script

ほとんどの機能は go-pty に丸投げで必要最小限しか実装していないのですが、意外とちゃんと機能してる感じです。ただし、直接コンソールの機能をコールしているテキストエディターなどを起動すると画面が乱れたりしますが、さすがにそれは仕方ないかなと。

まぁ、興味ある方はいっぺん使ってみてくださいませ
