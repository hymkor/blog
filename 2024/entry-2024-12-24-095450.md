Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/12/24/095450
Rem: App-Edited: 2024-12-24T09:56:01+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6802418398314102289
Rem: Published: 2024-12-24T09:54:50+09:00
Category:
Updated: 2024-12-24T09:54:50+09:00
Title: lispect と ssh によってサーバー側で直接 `restic check` を行う
---
前回:[マイクラデータ・バックアップスクリプト（ UNCパス→一時的なネットワークドライブ化対応） - 標準愚痴出力](https://zetamatta.hatenablog.com/entry/2024/12/23/142259)

restic サーバを立てることで、ファイルサーバ上で10GB超のデータをエラーなくバックアップできるようになったが、ネットワークを介するため、とても遅い。

そこで ssh を使って、サーバ上で直接 `restic check --read-data` を行うようにしてみた。パスワードはターミナル操作自動化ツール [lispect](https://github.com/hymkor/lispect) を使って入力させる。


```
$ set RESTIC_PASSWORD=(resticのパスワード)
$ lispect.exe  verify-minecraft.lsp  (アカウント@ファイルサーバ名)  (サーバのパスワード)  (サーバ上のレポジトリパス)
```

**verify-minecraft.lsp**

```lisp
(catch 'main
  (let ((user-and-host (car ARGV))
        (password (elt ARGV 1))
        (repository (elt ARGV 2))
        (rep-password (getenv "RESTIC_PASSWORD"))
        (sshpid nil))
    ; Remote login to OS
    (setq sshpid (spawn "ssh" user-and-host))
    (expect*
      ("[fingerprint])?"
       (sendln "yes")
       (expect "password:"))
      (("Connection refused"
        "Could not resolve hostname")
       (throw 'main nil))
      ("password:"))
    (sendln password)
    (expect*
      ("Permission denied"
       (expect "password:")
       (send #\U3)
       (wait sshpid)
       (throw 'main nil))
      ("$ "))

    (sendln (string-append "restic -r \"" repository "\" check --read-data"))

    (expect*
      ("enter password for repository:"
       (sendln rep-password)))
    (expect "$ ")
    (sendln "exit")
    (wait sshpid)
    ) ; let
  ) ; block main
```

+ サーバー上のプロンプトには `$ ` が含まれているのが大前提となる。
+ ssh のコマンドライン上に直接 restic コマンドを書くと、ログイン処理が入らないせいか、USB3 ディスクにドライブ文字が割り当てられず、レポジトリが見えないという問題があった。そのため、愚直だが一旦シェルを起こしている。

結論からいうと、このスクリプト自体はちゃんと動くが、自分の環境では動かすわけにはいかなくなった。ファンが壊れた PC ではCPU温度が無茶苦茶高くなってしまったからだ。
(restic サーバでやった時はネットワークがボトルネックになったせいか、こんなに加熱しなかった）
