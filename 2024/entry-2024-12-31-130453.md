Rem: Alternate-Url: https://zetamatta.hatenablog.com/entry/2024/12/31/130453
Rem: App-Edited: 2024-12-31T13:04:53+09:00
Rem: Draft: no
Rem: Url-To-Edit: https://blog.hatena.ne.jp/zetamatta/zetamatta.hatenablog.com/atom/entry/6802418398316190617
Rem: Published: 2024-12-31T13:04:53+09:00
Category: go xml
Updated: 2024-12-31T13:04:53+09:00
Title: Go で "encoding/xml" で HTML を読む時の注意
---
単純に xml.Unmarshal を使って

```go
bin, err := io.ReadAll(os.Stdin)
if err != nil {
    return err
}
var htm Html
err = xml.Unmarshal(bin, &htm)
if err != nil {
    return err
}
```

と HTML を読み込むと、閉じていないタグがあるので：

```
XML syntax error on line 18: element <meta> closed by </head>
```

となりがち

### 間違った対応

[xml.HTMLAutoClose](https://pkg.go.dev/encoding/xml@go1.23.4#pkg-variables) というグローバル変数があるので、一見すると

```go
xml.HTMLAutoClose = append(xml.HTMLAutoClose,"meta")
```

とかすればよさそうだが、間違いだった。"meta" は既に最初からセットされている上に、Unmarshal はこのグローバル変数を呼んでいる気配がない。

### 正解

NewDecoder でインスタンスを作って、そのフィールドにタグなどをセットすべし。
`xml.HTMLAutoClose` や `xml.HTMLEntity` は、HTML向けの推奨値だった。

```go
decoder := xml.NewDecoder(os.Stdin)
decoder.Strict = false
decoder.AutoClose = xml.HTMLAutoClose
decoder.Entity = xml.HTMLEntity
decoder.Entity["nbsp"] = " "

var htm Html
err := decoder.Decode(&htm)
if err != nil {
    return err
}
```
